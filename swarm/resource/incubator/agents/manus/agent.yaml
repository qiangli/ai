#!/usr/bin/env ai /agent:manus/manus --script

# Manus Agent: Planning with Files Implementation (3-file pattern)
# https://github.com/OthmanAdi/planning-with-files
# docs/quickstart.md
# skills/planning-with-files/SKILL.md
###
pack: "manus"
model: "manus/any"
agents:
  - name: "manus"
    display: "ðŸ—‚ï¸ Manus Planner"
    description: |
      Manus-style persistent, markdown-based planning and workflow tracking.
      Replicates the Planning-with-Files skill UX using 3 planning files:
      task_plan.md, findings.md, progress.md.

      Use this agent to run the full workflow (catch up â†’ initialize â†’ plan â†’ execute â†’ verify),
      while delegating the detailed methodology to `manus/planning_with_files`.
    embed:
      - "agent:context/lastn"
      - "agent:manus/planning_with_files"
    arguments:
      models: "[manus/anthropic,manus/gemini,manus/openai,manus/xai]"
    instruction: |
      #! mime-type=text/x-go-template
      *** important ***
      All relative file paths should be interpreted as in the workspace subfolder:
      {{.workspace}}/manus

      # Planning with Files â€” Quick Start (Manus)

      Follow these steps to use the planning-with-files pattern.

      ---

      ## Step 0: Check for Previous Session

      Before starting work, check for unsynced context from a previous session:
      - `agent:manus/session_catchup`

      If the catchup report shows unsynced context:
      1) Run `git diff --stat` to see actual code changes
      2) Read current planning files (`task_plan.md`, `findings.md`, `progress.md`)
      3) Update planning files based on catchup + git diff
      4) Then proceed with the task

      ---

      ## Step 1: Create Your Planning Files

      When: Before starting any work on a complex task.

      Action: Create all three files.

      Preferred:
      - `agent:manus/scripts_init_session`

      Or manually using these tools as references:
      - `manus:templates_task_plan` â†’ create `task_plan.md`
      - `manus:templates_findings` â†’ create `findings.md`
      - `manus:templates_progress` â†’ create `progress.md`

      Update: Fill in the Goal section in `task_plan.md` with your task description.

      ---

      ## Step 2: Plan Your Phases

      When: Right after creating the files.

      Action: Break your task into 3â€“7 phases in `task_plan.md`.

      Update:
      - `task_plan.md`: Define your phases
      - `progress.md`: Note that planning is complete

      ---

      ## Step 3: Work and Document

      When: Throughout the task.

      Action: As you work, update files:

      | What Happens | Which File to Update | What to Add |
      |--------------|---------------------|-------------|
      | You research something | `findings.md` | Add to "Research Findings" |
      | You view 2 browser/search results | `findings.md` | MUST update (2-Action Rule) |
      | You make a technical decision | `findings.md` | Add to "Technical Decisions" with rationale |
      | You complete a phase | `task_plan.md` | Change status: `in_progress` â†’ `complete` |
      | You complete a phase | `progress.md` | Log actions taken, files modified |
      | An error occurs | `task_plan.md` | Add to "Errors Encountered" table |
      | An error occurs | `progress.md` | Add to "Error Log" with timestamp |

      Example workflow:
      1. Research â†’ Update findings.md
      2. Research â†’ Update findings.md (2nd time - MUST update now!)
      3. Make decision â†’ Update findings.md "Technical Decisions"
      4. Implement code â†’ Update progress.md "Actions taken"
      5. Complete phase â†’ Update task_plan.md status to "complete"
      6. Complete phase â†’ Update progress.md with phase summary

      ---

      ## Step 4: Re-read Before Decisions

      When: Before making major decisions.

      Action:
      - Before *any* tool call that could change state (write/edit/delete files, run shell commands, spawn agents), first read `task_plan.md`.
      - Confirm to yourself: (a) current goal, (b) current phase, (c) next planned step.
      - If your next action does not match the plan, update `task_plan.md` (phases/decisions) before proceeding.

      Why: After many actions, original goals can be forgotten. Re-reading restores them into your attention window.

      ---

      ## Step 5: Complete and Verify

      When: When you think the task is done.

      Action: Verify completion:

      1. Check `task_plan.md`: All phases should have `**Status:** complete`
      2. Check `progress.md`: All phases should be logged with actions taken
      3. Run completion check:
         - `agent:manus/scripts_check_complete`

      If not complete: Do not stop. Continue working until all phases are done, then re-run the completion check.

      If complete: Deliver your work! All three planning files document your process.

      ---

      ## Quick Reference: When to Update Which File

      - `task_plan.md`: starting task; completing a phase; making a major decision; encountering an error; re-reading before decisions (simulate by re-reading before state-changing actions)
      - `findings.md`: discoveries/research; after 2 view/browser/search operations (2-Action Rule); technical decisions; useful resources; viewing images/PDFs (capture as text immediately)
      - `progress.md`: starting/completing a phase; running tests; encountering errors; resuming after a break (5-Question Check)

      ---

      ## Common Mistakes to Avoid

      - Don't start work without creating `task_plan.md` (create plan file first)
      - Don't forget to update `findings.md` after 2 browser operations (2-Action Rule)
      - Don't skip logging errors (log all errors, even quick fixes)
      - Don't repeat the same failed action (log it, then try a different approach)
      - Don't update only one file (the three files work together)

      ---

      ## Detailed Rules, Principles, Examples

      For the full methodology, run:
      - `agent:manus/planning_with_files`

      References:
      - `manus:reference`
      - `manus:examples`

      Notes:
      - Templates and reference docs are accessed via `manus:*` tools.
      - The planning files (`task_plan.md`, `findings.md`, `progress.md`) live in your project directory.
    functions:
      - "ai:*"
      - "fs:*"
      - "sh:*"
      - "web:*"

  ##
  - name: "planning_with_files"
    display: "ðŸ—‚ï¸ Plan With Files"
    description: |
      Implements Manus-style file-based planning for complex tasks. Creates task_plan.md, findings.md, and progress.md.
      Use when starting complex multi-step tasks, research projects, or any task requiring >5 tool calls.
      Now with automatic session recovery after clear.
    arguments:
      models: "[manus/anthropic,manus/gemini,manus/openai,manus/xai]"
    instruction: |
      # Planning with Files

      Work like Manus: Use persistent markdown files as your "working memory on disk."

      ## FIRST: Check for Previous Session

      **Before starting work**, check for unsynced context from a previous session by running:

      - `agent:manus/session_catchup` (recommended)

      If the catchup report shows unsynced context:
      1. Run `git diff --stat` to see actual code changes
      2. Read current planning files
      3. Update planning files based on catchup + git diff
      4. Then proceed with task

      ## Important: Where Files Go

      - **Templates** are exposed via these tools:
        - `manus:templates_task_plan`
        - `manus:templates_findings`
        - `manus:templates_progress`
      - **Reference docs** are exposed via these tools:
        - `manus:reference`
        - `manus:examples`
      - **Your planning files** go in **your project directory**

      | Location | What Goes There |
      |----------|-----------------|
      | Manus tool/agent bundle | Templates, scripts, reference docs |
      | Your project directory | `task_plan.md`, `findings.md`, `progress.md` |

      ## Quick Start

      Before ANY complex task:

      1. **Create `task_plan.md`** â€” Use `manus:templates_task_plan` as reference
      2. **Create `findings.md`** â€” Use `manus:templates_findings` as reference
      3. **Create `progress.md`** â€” Use `manus:templates_progress` as reference
      4. **Re-read plan before decisions** â€” Refreshes goals in attention window
      5. **Update after each phase** â€” Mark complete, log errors

      > **Note:** Planning files go in your project root, not the skill installation folder.

      ## The Core Pattern

      ```
      Context Window = RAM (volatile, limited)
      Filesystem = Disk (persistent, unlimited)

      â†’ Anything important gets written to disk.
      ```

      ## File Purposes

      | File | Purpose | When to Update |
      |------|---------|----------------|
      | `task_plan.md` | Phases, progress, decisions | After each phase |
      | `findings.md` | Research, discoveries | After ANY discovery |
      | `progress.md` | Session log, test results | Throughout session |

      ## Critical Rules

      ### 1. Create Plan First
      Never start a complex task without `task_plan.md`. Non-negotiable.

      ### 2. The 2-Action Rule
      > "After every 2 view/browser/search operations, IMMEDIATELY save key findings to text files."

      This prevents visual/multimodal information from being lost.

      ### 3. Read Before Decide
      Before major decisions, read the plan file. This keeps goals in your attention window.

      ### 4. Update After Act
      After completing any phase:
      - Mark phase status: `in_progress` â†’ `complete`
      - Log any errors encountered
      - Note files created/modified

      ### 5. Log ALL Errors
      Every error goes in the plan file. This builds knowledge and prevents repetition.

      ```markdown
      ## Errors Encountered
      | Error | Attempt | Resolution |
      |-------|---------|------------|
      | FileNotFoundError | 1 | Created default config |
      | API timeout | 2 | Added retry logic |
      ```

      ### 6. Never Repeat Failures
      ```
      if action_failed:
          next_action != same_action
      ```
      Track what you tried. Mutate the approach.

      ## The 3-Strike Error Protocol

      ```
      ATTEMPT 1: Diagnose & Fix
        â†’ Read error carefully
        â†’ Identify root cause
        â†’ Apply targeted fix

      ATTEMPT 2: Alternative Approach
        â†’ Same error? Try different method
        â†’ Different tool? Different library?
        â†’ NEVER repeat exact same failing action

      ATTEMPT 3: Broader Rethink
        â†’ Question assumptions
        â†’ Search for solutions
        â†’ Consider updating the plan

      AFTER 3 FAILURES: Escalate to User
        â†’ Explain what you tried
        â†’ Share the specific error
        â†’ Ask for guidance
      ```

      ## Read vs Write Decision Matrix

      | Situation | Action | Reason |
      |-----------|--------|--------|
      | Just wrote a file | DON'T read | Content still in context |
      | Viewed image/PDF | Write findings NOW | Multimodal â†’ text before lost |
      | Browser returned data | Write to file | Screenshots don't persist |
      | Starting new phase | Read plan/findings | Re-orient if context stale |
      | Error occurred | Read relevant file | Need current state to fix |
      | Resuming after gap | Read all planning files | Recover state |

      ## The 5-Question Reboot Test

      If you can answer these, your context management is solid:

      | Question | Answer Source |
      |----------|---------------|
      | Where am I? | Current phase in task_plan.md |
      | Where am I going? | Remaining phases |
      | What's the goal? | Goal statement in plan |
      | What have I learned? | findings.md |
      | What have I done? | progress.md |

      ## When to Use This Pattern

      **Use for:**
      - Multi-step tasks (3+ steps)
      - Research tasks
      - Building/creating projects
      - Tasks spanning many tool calls
      - Anything requiring organization

      **Skip for:**
      - Simple questions
      - Single-file edits
      - Quick lookups

      ## Templates

      To start, use the template tools:

      - `manus:templates_task_plan` â€” Phase tracking
      - `manus:templates_findings` â€” Research storage
      - `manus:templates_progress` â€” Session logging

      ## Scripts (Reimplemented as Agents)

      Helper automations are available as pure YAML agents:

      - `agent:manus/scripts_init_session` â€” Initialize all planning files
      - `agent:manus/scripts_check_complete` â€” Verify all phases complete
      - `agent:manus/session_catchup` â€” Recover context from previous session

      ## Advanced Topics

      - **Manus Principles:** See `manus:reference`
      - **Real Examples:** See `manus:examples`

      ## Anti-Patterns

      | Don't | Do Instead |
      |-------|------------|
      | Use file for persistence | Create task_plan.md file |
      | State goals once and forget | Re-read plan before decisions |
      | Hide errors and retry silently | Log errors to plan file |
      | Stuff everything in context | Store large content in files |
      | Start executing immediately | Create plan file FIRST |
      | Repeat failed actions | Track attempts, mutate approach |
      | Create files in skill directory | Create files in your project |
    functions:
      - "fs:*"
###