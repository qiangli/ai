#!/usr/bin/env ai
#
# Agent-first Git suite (fully mechanical orchestrator).
#
# Main entry: agent:git/git
# - Deterministic routing only.
# - No ai:call_llm.
# - Freeform text is classified via sh:classifier (rule-based Go tool).
#
pack: "git"
agents:
  - name: "git"
    display: "Git Orchestrator (Mechanical)"
    description: "Deterministic routing to git sub-agents; freeform classified via sh:classifier (no LLM)."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        payload:
          type: "object"
          properties:
            action: { type: "string" }
            dir: { type: "string" }
            args: { type: "array", items: { type: "string" } }
            message: { type: "string" }
            rev: { type: "string" }
            path: { type: "string" }
            query: { type: "string" }
        # Backward compat:
        action: { type: "string" }
        dir: { type: "string" }
        args: { type: "array", items: { type: "string" } }
        message: { type: "string" }
        rev: { type: "string" }
        path: { type: "string" }
        query: { type: "string" }
      required: []
    instruction: |
      You are a fully mechanical Git orchestrator.

      Never call ai:call_llm.

      Input forms you may receive:
      - Structured: {payload:{action,dir,args,message,rev,path}}
      - Backward compat structured: {action,dir,args,message,rev,path}
      - Freeform: {payload:{query:"..."}} or {query:"..."}

      Routing rules:
      1) Extract the effective payload:
         - If payload exists, use it.
         - Otherwise build payload from top-level action/dir/args/message/rev/path/query.

      2) If payload.action is non-empty:
         - Route deterministically by spawning the matching sub-agent:
           status -> agent:git/status
           clone -> agent:git/clone
           commit -> agent:git/commit
           pull -> agent:git/pull
           push -> agent:git/push
           branch -> agent:git/branch
           remote-url -> agent:git/remote-url
           rev-parse -> agent:git/rev-parse
           list-branches -> agent:git/list-branches
           list-remotes -> agent:git/list-remotes
           latest-commit -> agent:git/latest-commit
           show-file -> agent:git/show-file

      3) Else if payload.query is non-empty:
         - Call sh:classifier with the query to obtain {action,dir,args,message,confidence}.
         - If confidence < 0.7 OR action is empty:
           return a JSON object asking ONE clarifying question, like:
             {
               "ok": false,
               "needs_clarification": true,
               "question": "I couldn't determine the git action. Please specify one of: status, clone, commit, pull, push, branch, remote-url, rev-parse, list-branches, list-remotes, latest-commit, show-file. Also include repo dir if needed.",
               "classifier": { ...full classifier output... }
             }
           and STOP.
         - Otherwise, route to the chosen sub-agent using the classifier outputs as the payload.

      4) Else:
         return a JSON error telling the user to provide action or query.

      Output requirements:
      - For successful operations, return the sub-agent's JSON output.
      - For clarification requests, return the structured clarification JSON described above.
    functions:
      - "ai:spawn_agent"
      - "sh:classifier"
      - "agent:git/status"
      - "agent:git/clone"
      - "agent:git/commit"
      - "agent:git/pull"
      - "agent:git/push"
      - "agent:git/branch"
      - "agent:git/remote-url"
      - "agent:git/rev-parse"
      - "agent:git/list-branches"
      - "agent:git/list-remotes"
      - "agent:git/latest-commit"
      - "agent:git/show-file"

  - name: "status"
    display: "git status"
    description: "Deterministic git status (porcelain)."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"status",dir}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "clone"
    display: "git clone"
    description: "Deterministic git clone."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        repo_url: { type: "string" }
        dest_dir: { type: "string" }
      required: ["repo_url","dest_dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"clone",args:[repo_url,dest_dir]}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "commit"
    display: "git commit"
    description: "Deterministic git commit."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
        message: { type: "string" }
      required: ["dir","message"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"commit",dir,message}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "pull"
    display: "git pull"
    description: "Deterministic git pull."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
        args: { type: "array", items: { type: "string" } }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"pull",dir,args}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "push"
    display: "git push"
    description: "Deterministic git push."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
        args: { type: "array", items: { type: "string" } }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"push",dir,args}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "branch"
    display: "git branch (current)"
    description: "Deterministic current branch lookup."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"branch",dir}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "remote-url"
    display: "git remote-url"
    description: "Deterministic origin remote URL lookup."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"remote-url",dir}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "rev-parse"
    display: "git rev-parse"
    description: "Deterministic rev-parse."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
        rev: { type: "string" }
      required: ["dir","rev"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"rev-parse",dir,rev}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "list-branches"
    display: "git list-branches"
    description: "Deterministic local branch list."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"list-branches",dir}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "list-remotes"
    display: "git list-remotes"
    description: "Deterministic remote list."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"list-remotes",dir}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "latest-commit"
    display: "git latest-commit"
    description: "Deterministic latest commit line."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
      required: ["dir"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"latest-commit",dir}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]

  - name: "show-file"
    display: "git show-file"
    description: "Deterministic show file content at rev."
    model: "default/any"
    parameters:
      type: "object"
      properties:
        id: { type: "string" }
        user: { type: "string" }
        dir: { type: "string" }
        rev: { type: "string" }
        path: { type: "string" }
      required: ["dir","rev","path"]
    instruction: |
      Call sh:git-tool with envelope {id,user,payload:{action:"show-file",dir,rev,path}}.
      Return the tool JSON as-is.
    functions: ["sh:git-tool"]
