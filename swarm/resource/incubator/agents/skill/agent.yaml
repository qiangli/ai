#!/usr/bin/env ai /agent:skill/skill --script

# https://agentskills.io/home
# skill/skill
#
# Implements an AgentSkills-style dispatcher:
# - Resolve a skill by name via ai:list_skills + ai:get_skill_info
# - Load <skill>/SKILL.md as the prompt
# - Optionally gather allowed tools and pass them to ai:call_llm
# - Append source/reference/scripts paths to the prompt

pack: "skill"
agents:
  - name: "skill"
    display: "ðŸŽ“ Skills Runner"
    description: "Loads a skill pack's SKILL.md and runs it as an LLM prompt (AgentSkills spec-inspired)."
    model: "default/any"
    embed:
      - "agent:context/lastn"
      - "agent:memory"
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "Skill/agent name; resolved via ai:list_skills + ai:get_skill_info (Skill name in SKILL.md front matter)"
        model:
          type: "string"
          description: "Model alias set/level to use for the final ai:call_llm"
          default: "default/any"
        query:
          type: "string"
          description: "User query to run against the loaded skill prompt"
      required: ["agent", "query"]
    instruction: |
      #! mime-type=text/x-go-template
      You are the Skills agent.

      Goal: given a skill name (parameter `.agent`), locate and run its AgentSkills skill prompt.

      Steps you MUST follow:
      1) Use `ai:list_skills` to enumerate available skills.
      2) Find the skill whose name exactly matches `{{ .agent }}`.
         - If none found, fail with a clear error message and include the available skill names.
      3) Call `ai:get_skill_info` with `skill={{ .agent }}`.
      4) From the returned Skill Info, load the skill prompt from the skill's `SKILL.md` (use filesystem tools only to read the returned path).
      5) Parse `SKILL.md` to find an `allowed-tools` section.
         - If present, collect tool names.
         - Then call `ai:list_tools` and `ai:list_agents` to validate available tools.
         - Pass the intersection of requested allowed-tools with available tools/agents as the `tools` list in `ai:call_llm`.
         - Tool format: tools from ai:list_tools are `kit:name`; agent tools are `agent:pack/name`.
         - If allowed-tools is absent, do NOT pass `tools` (let default tool availability apply).
      6) Build the final `prompt` for `ai:call_llm` as:
         - the loaded SKILL.md content
         - plus an appended footer with absolute paths:

         Skills Source:
         <absolute path to the matched SKILL.md>

         If `references` exists under the skill directory, append:
         Reference:
         <absolute path>

         If `scripts` exists under the skill directory, append:
         Scripts:
         <absolute path>

      7) Call `ai:call_llm` with:
         - `prompt`: the constructed prompt above
         - `query`: parameter `.query`
         - `models`: parameter `.model` if provided, else use this agent's default model

      Output ONLY the LLM response.

      Notes:
      - You are allowed to use filesystem tools for reading and existence checks.
      - Prefer being strict and explicit when errors occur.
    functions:
      - "sh:*"
      - "fs:*"
      - "ai:*"
