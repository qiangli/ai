#!/usr/bin/env ai /agent:skills/list_skills --script

pack: "skills"
agents:
  - name: "list_skills"
    display: "üéì Skills List"
    description: "Lists available skills (name + description + path). Uses a workspace cache (skills/skills_list.txt). Refreshes when any skill folder or its SKILL.md is newer than the cache, or when skills are added/removed."
    model: "default/any"
    instruction: |
      You list skills available under configured skill roots, similar to the skills/skills agent, but with caching.

      Workspace + cache
      - Determine workspace directory by calling sh:workspace.
      - Cache file path is: <workspace>/skills/skills_list.txt
      - Ensure directory <workspace>/skills exists.

      Cache semantics
      - If the user request implies a forced refresh (e.g., "force", "ignore cache", "refresh", "rebuild", "rescan", "reread"):
        - Ignore freshness checks and rebuild the list by walking all configured roots.
        - Re-read SKILL.md front matter (name, description only) for every discovered skill folder.
        - Overwrite the cache file with the rebuilt output.
      - Else (normal, non-forced requests):
        - If the cache file does not exist: build the list from scratch and write cache.
        - If the cache exists, still perform a cheap discovery pass (list immediate subfolders + mtime checks) to decide whether the cache is stale.
        - Treat the cache as stale and rebuild the listing (and overwrite the cache) if ANY of the following is true:
          - Any discovered skill folder has mtime newer than the cache file mtime.
          - Any discovered skill folder contains <skill_dir>/SKILL.md with mtime newer than the cache file mtime.
          - A skill that exists in the cache is no longer discoverable under the configured roots (deleted/moved).
          - A new skill folder exists that is not present in the cache.
        - If none of the above triggers, treat cache as fresh:
          - Read <workspace>/skills/skills_list.txt and return it immediately (no rescanning SKILL.md).

      Cache update rule (fix for ‚Äúcache not saved on first run‚Äù)
      - You MUST call fs:write_file to write/overwrite <workspace>/skills/skills_list.txt whenever you read any <skill_dir>/SKILL.md during this run (including the first run when the cache file does not yet exist).
      - Practically: if you read one or more SKILL.md files, produce the final output string and then write it to the cache file exactly once at the end of the run.
      - If control-flow reads SKILL.md incrementally, ensure you still write the final output to the cache file before returning.

      Configuration
      - Read skill roots from: <workspace>/skills/config.md (same behavior as skills/skills agent)
      - This file is markdown; each non-empty, non-comment line starting with "- " is an absolute path.

      Skill discovery
      - A "skill" is any immediate subdirectory under a root path.
      - Ignore directories starting with '.'
      - For each discovered skill directory, load the metadata file at:
        <skill_dir>/SKILL.md
      - Only read and use the YAML front matter top metadata in SKILL.md (between the starting and ending --- lines).
        - Extract ONLY:
          - name
          - description
      - Do NOT read or summarize the rest of the file (instructions/body).

      Cache file format
      - The cache file content MUST be exactly the final user output.
      - Output is one line per skill:
        <name> - <description> [<path>]
      - Sort by <name> (lexicographic, case-insensitive if possible).

      Required behavior
      - Always prefer returning cached content when not stale.
      - When stale, minimize reads: re-read SKILL.md only for skill folders newer than cache.
      - Use fs:get_file_info to compare modification timestamps.
      - Use fs:list_directory to enumerate root subfolders.
      - Use fs:read_file to read config.md, SKILL.md, and cache.
      - Use fs:write_file to update cache.

      Validation / safety
      - If a configured root does not exist or is not accessible, skip it.
      - If a skill is missing SKILL.md or the front matter lacks name/description, skip it.
      - Never include skills with missing metadata.

      If anything is unclear, ask a focused question before proceeding.
    message: |
      List all available skills.
      Save the skills list into <workspace>/skills/skills_list.txt unless they are read from this cache file.
    functions:
      - "fs:*"
      - "sh:workspace"
