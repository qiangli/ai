###
kit: "ai"
type: "ai"

tools:
  - name: "ai"
    display: "AI"
    description: |
      A framework for managing AI agents, tools, and models.
    parameters: {}
    type: "func"
    body:
      mime_type: "application/x-sh"
      script: |
        #!/bin/bash
        /ai:help
        exit 0

  - name: "help"
    display: "AI Tool Help"
    description: |
      A set of tools for managing agents, tools, and models.
    parameters: {}
    type: "func"
    body:
      mime_type: "application/x-go"
      script: |
        import "fmt"
        const desc = `
        # DHNT.io AI

        A set of tools for managing agents, tools, and models.

        ## Agents
          + ai:list_agents
          + ai:get_agent_info
          + ai:spawn_agent

        ## Tools
          + ai:list_tools
          + ai:get_tool_info

        ## Models 
          + ai:list_models
        `
        func main() {
          fmt.Printf(desc)
        }
    log_level: "quiet"

  - name: "call_llm"
    description: |
      Connects to the LLM, sends a request, and retrieves a response, with optional tool calls.
    parameters:
      type: "object"
      properties:
        prompt:
          type: "string"
          description: "System prompt for guiding the LLM's response. Acts as instructions for the LLM."
        query:
          type: "string"
          description: "The main content or question from the user that requires a response from the LLM."
        model:
          type: "string"
          description: |
            Specifies the LLM model to use. Defaults to 'default/any' if not provided.
            Ensure the model name is valid. Use the 'ai:list_models' tool to view available models.
        tools:
          type: "array"
          items:
            type: "string"
          description: |
            List of tool names to utilize during the LLM call, specified in the format 'kit:name'.
            Ensure each tool name is valid using the 'ai:list_tools' tool to find the available tools.
            Agents can be run as tools with `agent` as the kit, e.g.: 'agent:<agent_name>'.
            Ensure the agent name is valid using the 'ai:list_agents' tool to find available agents.
        temperature:
          type: "number"
          description: |
            What sampling temperature to use, between 0 and 2.
            Higher values like 0.8 will make the output more random, while lower values like 0.2 will make it more focused and deterministic.
            We generally recommend altering this or top_p but not both.
          default: 1
          minimum: 0
          maximum: 2
        top_p:
          type: "number"
          description: |
            An alternative to sampling with temperature, called nucleus sampling,
            where the model considers the results of the tokens with top_p probability mass. 
            So 0.1 means only the tokens comprising the top 10% probability mass are considered.
            It is generally recommended to alter this or temperature but not both.
          default: 1
          minimum: 0
          maximum: 1
      required:
        - query

  - name: "list_agents"
    description: "Retrieve the list of AI agents accessible to the current user"
    parameters:
      type: object
      properties: {}

  - name: "get_agent_info"
    description: "Retrieve detailed information about a specified agent, including display name, description, and instructions"
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "The name of the agent"
      required:
        - "agent"

  - name: "read_agent_config"
    description: |
      Retrieve the configuration used to create a specified agent instance.
      The content may also include configurations for other agents in the same
      package as well as tools and models utilized by the agents.
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: |
            The name of the agent for which the configuration is requested.
            Use 'self' to refer to the current agent invoking the tool.
        script:
          type: "string"
          description: "Load agent configuration from the script's content"
      required:
        - "agent"

  - name: "new_agent"
    description: "Create an instance of a new agent by name"
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "The name of the agent"
      required:
        - "agent"

  # - name: "build_agent"
  #   description: |
  #     Construct user query based on user's message input. Retrieve the prompt
  #     from instructions specified in the agent configuration and context from
  #     the historical conversation messages. Applies templates formatted
  #     using Golang template syntax.
  #     This is equivalent to running flow:sequence ["ai:build_query","ai:build_prompt","ai:build_context"]
  #   parameters:
  #     type: "object"
  #     properties:
  #       agent:
  #         type: "string"
  #         description: "Specifies the name of the agent to construct."
  #     required:
  #       - "agent"
  #   type: "func"
  #   body:
  #     mime_type: "application/x-sh"
  #     script: |
  #       #!/bin/bash
  #       actions='["ai:build_query","ai:build_prompt","ai:build_context"]'
  #       /flow:sequence --agent "${agent}" --actions "${actions}"
  #       exit 0

  - name: "build_query"
    description: |
      Constructs a user role prompt for the agent based on the user input message.
      Applies templates if the input message is a Golang template.
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "The name of the agent"
      required:
        - "agent"

  - name: "build_prompt"
    description: |
      Constructs a system role prompt for the agent based on the instruction specified in the configuration.
      Applies templates if the instruction is a Golang template.
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "The name of the agent"
      required:
        - "agent"

  - name: "build_context"
    description: |
      Constructs the historical context for the agent based on past chat messages or other data sources.
      Applies templating if Golang templates are detected in the text.
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "Specifies the name of the agent for which the context is being built."
      required:
        - "agent"

  # - name: "build_model"
  #   description: |
  #     Constructs the model for the agent. Resolve LLM providers, base URL, and
  #     API key.
  #   parameters:
  #     type: "object"
  #     properties:
  #       agent:
  #         type: "string"
  #         description: "Specifies the name of the agent for which the model is being built."
  #     required:
  #       - "agent"

  # - name: "build_tools"
  #   description: |
  #     Resolve tools for the agent and inherit tools from embedded agents.
  #   parameters:
  #     type: "object"
  #     properties:
  #       agent:
  #         type: "string"
  #         description: "Specifies the name of the agent"
  #     required:
  #       - "agent"

  - name: "transfer_agent"
    description: "Trasnfer the current task to a specific agent"
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "The name of the agent"
      required:
        - "agent"

  # - name: "reload_agent"
  #   description: |
  #     Reload the current agent with a new configuration.
  #     The script can be a file path or inline with the "data:" prefix.
  #     Ensure the script is a properly formatted YAML file.
  #   parameters:
  #     type: "object"
  #     properties:
  #       script:
  #         type: "string"
  #         description: |
  #           Path to the script file or inline script prefixed with 'data:'.
  #           The script is used to reconfigure the agent.
  #     required:
  #       - "script"

  - name: "spawn_agent"
    description: "Delegate the current task to a specific agent"
    parameters:
      type: "object"
      properties:
        agent:
          type: "string"
          description: "The name of the agent"
        query:
          type: "string"
          description: "The user query string"
        entrypoint:
          type: "array"
          items:
            type: "string"
          description: |
            Optional. list of action names, specified in the format 'kit:name'.
            For agents, use 'agent' as the kit value.
            Ensure each action name is valid using the 'ai:list_tools' or 'ai:list_agents' tool
            to find the available tools and agents.
            + Tools: <kit>:<name>
            + Agents: agent:<pack/name>
            Default entrypoint if not specified:
              "[ai:new_agent,ai:build_query,ai:build_prompt,ai:build_context,ai:call_llm]"
      required:
        - "agent"
        - "query"

  - name: "list_tools"
    description: "Enumerate AI tool functions available for selection"
    parameters:
      type: object
      properties: {}

  - name: "get_tool_info"
    description: "Get information about a specific tool"
    parameters:
      type: "object"
      properties:
        tool:
          type: "string"
          description: "The name of the tool"
      required:
        - "tool"

  - name: "read_tool_config"
    description: |
      Retrieve the configuration used to create a tool call function.
      The content may also include configurations for other tools within the same toolkit.
    parameters:
      type: "object"
      properties:
        tool:
          type: "string"
          description: "The name of the tool"
        script:
          type: "string"
          description: "Load tool configuration from the script's content"
      required:
        - "tool"

  # - name: "execute_tool"
  #   description: "Call the tool function"
  #   parameters:
  #     type: "object"
  #     properties:
  #       tool:
  #         type: "string"
  #         description: "The name of the tool"
  #       parameters:
  #         type: "object"
  #         description: "The arguments for the tool call"
  #         properties: {}
  #     required:
  #       - "tool"
  #       - "parameters"

  - name: "list_models"
    description: |
      List all AI large language model aliases (set/level) available to the current user.
    parameters:
      type: object
      properties: {}

  - name: "list_messages"
    description: "Retrieve a list of messages from past conversations based on specified criteria"
    parameters:
      type: "object"
      properties:
        max_history:
          type: "integer"
          description: "The maximum number of historic messages to retrieve"
          default: 5
          minimum: 0
        max_span:
          type: "integer"
          description: "The time frame, in minutes, to look back for past messages"
          default: 1440
          minimum: 0
        # offset:
        #   type: "integer"
        #   description: "The number of most recent messages to skip before retrieving the specified past messages"
        #   default: 0
        #   minimum: 0
        # roles:
        #   type: "array"
        #   description: "Specify roles to include, such as system, assistant, and user. By default, [assistant, user] are included, while system is excluded."
        #   items:
        #     type: "string"

  # - name: "get_message_info"
  #   description: "Retrieve detailed information for a specific message from past conversations by id."
  #   parameters:
  #     type: "object"
  #     properties:
  #       id:
  #         type: "string"
  #         description: "A unique identifier for the message"
  #     required:
  #       - "id"

  - name: "save_messages"
    description: |
      Save a list of messages in JSON array format.
      This tool enables you to store messages, which is useful for maintaining and providing context for future conversations.
    parameters:
      type: "object"
      properties:
        messages:
          type: "string"
          description: |
            Provide a list of messages to be saved in JSON array format.
            Ongoing conversations are automatically saved, but you can add
            additional messages for enhanced future context by using this tool.
            Stored messages can later be retrieved with the list_messages tool.

            Example message format:
            ```json
            [
              {
                "id": "e90bb578-6654-4bd3-88f5-d09898ed9ef7",
                "session": "eb104d8d-3929-4f77-bba7-1c0a0e1cbd1c",
                "created": "2026-01-13T07:06:12.075809-08:00",
                "content_type": "text/plain",
                "content": "Hello, World!",
                "role": "user",
                "sender": "",
                "agent": ""
              }
              ...
            ]
            ```
      required:
        - messages

  - name: "sleep"
    description: "Suspend execution for an interval of time"
    parameters:
      type: "object"
      properties:
        duration:
          type: "string"
          description: "Duration in seconds, minutes, hours, or days. Accepted formats: '10', '10s', '5m', '2h', '1d'. Default is seconds if no suffix is provided."
        message:
          type: "string"
          description: "An optional message to display when the specified duration elapses."
      required:
        - duration
    type: "func"
    body:
      mime_type: "application/x-go"
      script: |
        import (
          "fmt"
          "os"
          "strconv"
          "strings"
          "time"
        )

        // parseDurationExt supports time.ParseDuration plus an extra 'd' suffix for days.
        func parseDurationExt(s string) (time.Duration, error) {
          s = strings.TrimSpace(s)
          if s == "" {
            return 0, fmt.Errorf("duration is required")
          }

          // Support day suffix like "2d".
          if strings.HasSuffix(s, "d") {
            v := strings.TrimSuffix(s, "d")
            if v == "" {
              return 0, fmt.Errorf("invalid duration %q", s)
            }
            f, err := strconv.ParseFloat(v, 64)
            if err != nil {
              return 0, fmt.Errorf("invalid duration %q: %v", s, err)
            }
            if f < 0 {
              return 0, fmt.Errorf("duration must be non-negative")
            }
            return time.Duration(f * float64(24*time.Hour)), nil
          }

          // If no unit is provided, treat as seconds (Unix sleep behavior).
          last := s[len(s)-1]
          if last >= '0' && last <= '9' {
            s = s + "s"
          }

          d, err := time.ParseDuration(s)
          if err != nil {
            return 0, err
          }
          if d < 0 {
            return 0, fmt.Errorf("duration must be non-negative")
          }
          return d, nil
        }

        func main() {
          // Parameters are injected as global variables by the runtime.
          duration := os.Getenv("duration")
          if duration == "" {
            // Some runtimes inject as global var; try fallback.
            duration = ""
          }

          d, err := parseDurationExt(duration)
          if err != nil {
            fmt.Fprintln(os.Stderr, err.Error())
            os.Exit(1)
          }

          time.Sleep(d)
          message := os.Getenv("message")
          if message != "" {
            fmt.Println(message)
          }
        }

  - name: "callback"
    description: |
      Schedule and invoke a follow-up action (tool/agent/command) using slash-command syntax.

      This is useful for LLM infinite-loop control, e.g. schedule a retry after a delay.
    type: "func"
    parameters:
      type: "object"
      properties:
        wait:
          type: "string"
          description: "Optional wait before action"
        action:
          type: "string"
          description: |
            Action command/agent/tool to run.
            Must be invoked via slash command syntax, e.g. `/ai:call_llm ...` or `/sh:bash ...`.
      required:
        - action
    body:
      mime_type: "application/x-sh"
      script: |
        #!/bin/bash

        set -euo pipefail

        if [[ -z "${action:-}" ]]; then
          echo "ai:callback: missing required parameter: action" >&2
          exit 2
        fi

        if [[ "${action}" != /* ]]; then
          echo "ai:callback: invalid action: must begin with '/' (slash command syntax), got: ${action}" >&2
          exit 2
        fi

        if [[ -n "${wait:-}" ]]; then
          /ai:sleep --duration "${wait}"
        fi

        # Execute the action as a single command string to preserve spacing/quoting.
        eval "${action}"
        exit $?
